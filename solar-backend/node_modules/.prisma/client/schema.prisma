generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Sites (Plants)
model Site {
  id          String   @id @default(uuid())
  name        String
  capacityKwp Decimal? @map("capacity_kwp") @db.Decimal(10, 2)
  location    String?
  status      String   @default("active") // active, inactive
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  devices Device[]
  alerts  Alert[]

  @@map("sites")
}

// Devices
model Device {
  id        String       @id @default(uuid())
  siteId    String       @map("site_id")
  name      String
  type      DeviceType
  protocol  Protocol
  ipAddress String?      @map("ip_address")
  port      Int          @default(502)
  slaveId   Int          @default(1) @map("slave_id")
  status    DeviceStatus @default(OFFLINE)
  lastSeen  DateTime?    @map("last_seen")
  createdAt DateTime     @default(now()) @map("created_at")

  // MODBUS_RTU specific
  serialPort String? @map("serial_port")
  baudRate   Int?    @map("baud_rate")
  dataBits   Int?    @map("data_bits")
  parity     String? @map("parity")
  stopBits   Int?    @map("stop_bits")

  // IEC104 specific
  commonAddress Int? @map("common_address")

  // BACNET_IP specific
  deviceInstance Int? @map("device_instance")

  // MELSEC specific
  networkNumber Int? @map("network_number")
  stationNumber Int? @map("station_number")

  site      Site        @relation(fields: [siteId], references: [id], onDelete: Cascade)
  telemetry Telemetry[]
  alerts    Alert[]

  @@map("devices")
}

enum DeviceType {
  INVERTER
  METER
  SENSOR
}

enum Protocol {
  MODBUS_TCP
  MODBUS_RTU
  IEC104
  BACNET_IP
  MELSEC
}

enum DeviceStatus {
  ONLINE
  OFFLINE
  WARNING
  CRITICAL
}

// Modbus Profiles
model ModbusProfile {
  id           String   @id @default(uuid())
  deviceType   String   @map("device_type")
  name         String?
  registersMap Json     @map("registers_map") // JSONB array of register mappings
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  @@map("modbus_profiles")
}

// Telemetry (will be converted to hypertable)
model Telemetry {
  time         DateTime @map("time")
  deviceId     String   @map("device_id")
  parameterKey String   @map("parameter_key")
  value        Float?

  device Device @relation(fields: [deviceId], references: [id], onDelete: Cascade)

  @@id([time, deviceId, parameterKey])
  @@index([deviceId])
  @@index([time])
  @@map("telemetry")
}

// Alerts
model Alert {
  id             String      @id @default(uuid())
  deviceId       String?     @map("device_id")
  siteId         String?     @map("site_id")
  level          AlertLevel
  message        String
  status         AlertStatus @default(OPEN)
  acknowledgedBy String?     @map("acknowledged_by")
  acknowledgedAt DateTime?   @map("acknowledged_at")
  comment        String?
  createdAt      DateTime    @default(now()) @map("created_at")

  device       Device? @relation(fields: [deviceId], references: [id], onDelete: SetNull)
  site         Site?   @relation(fields: [siteId], references: [id], onDelete: SetNull)
  acknowledger User?   @relation(fields: [acknowledgedBy], references: [id])

  @@map("alerts")
}

enum AlertLevel {
  CRITICAL
  MAJOR
  MINOR
  WARNING
}

enum AlertStatus {
  OPEN
  ACKNOWLEDGED
  RESOLVED
}

// Users
model User {
  id           String   @id @default(uuid())
  username     String   @unique
  email        String?  @unique
  passwordHash String   @map("password_hash")
  role         UserRole @default(OPERATOR)
  createdAt    DateTime @default(now()) @map("created_at")

  alerts Alert[]

  @@map("users")
}

enum UserRole {
  ADMIN
  ENGINEER
  OPERATOR
  VIEWER
}
